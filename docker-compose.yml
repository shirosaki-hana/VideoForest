# =============================================================================
# VideoForest Docker Compose Configuration
# =============================================================================
#
# 사용법:
#   CPU 모드:     docker compose up -d
#   NVIDIA GPU:   docker compose --profile nvidia up -d
#   Intel QSV:    docker compose --profile intel up -d
#
# 첫 실행 전:
#   1. .env.docker.example을 .env로 복사
#   2. .env 파일에서 미디어 경로 설정
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # 기본 서비스 (CPU 인코딩)
  # ---------------------------------------------------------------------------
  videoforest:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: videoforest
    restart: unless-stopped
    ports:
      - "${PORT:-4001}:4001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=0.0.0.0
      - PORT=4001
      - DATABASE_URL_SQLITE=file:/app/data/videoforest.db
      - MEDIA_PATHS=${MEDIA_PATHS:-/media}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:4001}
      - SESSION_TTL=${SESSION_TTL:-24h}
      - SESSION_COOKIE=${SESSION_COOKIE:-session}
      - RATELIMIT_MAX=${RATELIMIT_MAX:-100}
      - RATELIMIT_WINDOWMS=${RATELIMIT_WINDOWMS:-10s}
      - HLS_TEMP_DIR=/app/backend/temp
      - VIDEOFOREST_ENCODER=${VIDEOFOREST_ENCODER:-auto}
      - VIDEOFOREST_SPEED_MODE=${VIDEOFOREST_SPEED_MODE:-0}
      - VIDEOFOREST_PREFETCH_ENABLED=${VIDEOFOREST_PREFETCH_ENABLED:-1}
      - VIDEOFOREST_PREFETCH_COUNT=${VIDEOFOREST_PREFETCH_COUNT:-3}
      - VIDEOFOREST_MAX_CONCURRENT_PREFETCH=${VIDEOFOREST_MAX_CONCURRENT_PREFETCH:-2}
    volumes:
      # SQLite 데이터베이스 영속화
      - videoforest-data:/app/data
      # HLS 임시 파일 (선택적 - 재시작 시 캐시 유지)
      - videoforest-temp:/app/backend/temp
      # 미디어 라이브러리 마운트 (읽기 전용)
      # 여러 경로가 필요하면 아래처럼 추가하세요
      - ${MEDIA_PATH_1:-./media}:/media/library1:ro
      # - ${MEDIA_PATH_2:-./media2}:/media/library2:ro
      # - ${MEDIA_PATH_3:-./media3}:/media/library3:ro
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4001/api/auth/status').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # NVIDIA GPU 지원 서비스
  # 사용: docker compose --profile nvidia up -d
  # 요구사항: NVIDIA Container Toolkit 설치 필요
  # ---------------------------------------------------------------------------
  videoforest-nvidia:
    extends:
      service: videoforest
    container_name: videoforest-nvidia
    profiles:
      - nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
                - video  # NVENC/NVDEC 지원
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=0.0.0.0
      - PORT=4001
      - DATABASE_URL_SQLITE=file:/app/data/videoforest.db
      - MEDIA_PATHS=${MEDIA_PATHS:-/media}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:4001}
      - SESSION_TTL=${SESSION_TTL:-24h}
      - SESSION_COOKIE=${SESSION_COOKIE:-session}
      - RATELIMIT_MAX=${RATELIMIT_MAX:-100}
      - RATELIMIT_WINDOWMS=${RATELIMIT_WINDOWMS:-10s}
      - HLS_TEMP_DIR=/app/backend/temp
      - VIDEOFOREST_ENCODER=${VIDEOFOREST_ENCODER:-auto}
      - VIDEOFOREST_SPEED_MODE=${VIDEOFOREST_SPEED_MODE:-0}
      - VIDEOFOREST_PREFETCH_ENABLED=${VIDEOFOREST_PREFETCH_ENABLED:-1}
      - VIDEOFOREST_PREFETCH_COUNT=${VIDEOFOREST_PREFETCH_COUNT:-3}
      - VIDEOFOREST_MAX_CONCURRENT_PREFETCH=${VIDEOFOREST_MAX_CONCURRENT_PREFETCH:-2}
      # NVIDIA 런타임 환경 변수
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility

  # ---------------------------------------------------------------------------
  # Intel QSV 지원 서비스
  # 사용: docker compose --profile intel up -d
  # 요구사항: Intel GPU가 있는 시스템, VA-API 드라이버
  # ---------------------------------------------------------------------------
  videoforest-intel:
    extends:
      service: videoforest
    container_name: videoforest-intel
    profiles:
      - intel
    devices:
      # Intel GPU 디바이스 패스스루 (DRI - Direct Rendering Infrastructure)
      - /dev/dri:/dev/dri
    group_add:
      # render 그룹 접근 권한 (Intel GPU 사용에 필요)
      - "109"  # render group (시스템에 따라 다를 수 있음, `getent group render` 로 확인)
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=0.0.0.0
      - PORT=4001
      - DATABASE_URL_SQLITE=file:/app/data/videoforest.db
      - MEDIA_PATHS=${MEDIA_PATHS:-/media}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:4001}
      - SESSION_TTL=${SESSION_TTL:-24h}
      - SESSION_COOKIE=${SESSION_COOKIE:-session}
      - RATELIMIT_MAX=${RATELIMIT_MAX:-100}
      - RATELIMIT_WINDOWMS=${RATELIMIT_WINDOWMS:-10s}
      - HLS_TEMP_DIR=/app/backend/temp
      - VIDEOFOREST_ENCODER=${VIDEOFOREST_ENCODER:-auto}
      - VIDEOFOREST_SPEED_MODE=${VIDEOFOREST_SPEED_MODE:-0}
      - VIDEOFOREST_PREFETCH_ENABLED=${VIDEOFOREST_PREFETCH_ENABLED:-1}
      - VIDEOFOREST_PREFETCH_COUNT=${VIDEOFOREST_PREFETCH_COUNT:-3}
      - VIDEOFOREST_MAX_CONCURRENT_PREFETCH=${VIDEOFOREST_MAX_CONCURRENT_PREFETCH:-2}
      # VA-API 환경 변수
      - LIBVA_DRIVER_NAME=iHD

# -----------------------------------------------------------------------------
# Named Volumes
# -----------------------------------------------------------------------------
volumes:
  videoforest-data:
    name: videoforest-data
  videoforest-temp:
    name: videoforest-temp

