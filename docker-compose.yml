# =============================================================================
# VideoForest Docker Compose Configuration
# =============================================================================
#
# 사용법:
#   docker compose up -d        # 서비스 시작 (백그라운드)
#   docker compose up --build   # 이미지 다시 빌드하고 시작
#   docker compose down         # 서비스 중지 및 삭제
#   docker compose logs -f      # 로그 보기
#
# 첫 실행 전:
#   1. .env.docker.example을 .env로 복사
#   2. .env 파일에서 미디어 경로 설정
#
# =============================================================================

services:
  videoforest:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: videoforest
    restart: unless-stopped
    ports:
      - "${PORT:-4001}:4001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=0.0.0.0
      - PORT=4001
      - DATABASE_URL_SQLITE=file:/app/data/videoforest.db
      - MEDIA_PATHS=${MEDIA_PATHS:-/media}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:4001}
      - SESSION_TTL=${SESSION_TTL:-24h}
      - SESSION_COOKIE=${SESSION_COOKIE:-session}
      - RATELIMIT_MAX=${RATELIMIT_MAX:-100}
      - RATELIMIT_WINDOWMS=${RATELIMIT_WINDOWMS:-10s}
      - HLS_TEMP_DIR=/app/backend/temp
      - VIDEOFOREST_ENCODER=${VIDEOFOREST_ENCODER:-auto}
      - VIDEOFOREST_SPEED_MODE=${VIDEOFOREST_SPEED_MODE:-0}
      - VIDEOFOREST_PREFETCH_ENABLED=${VIDEOFOREST_PREFETCH_ENABLED:-1}
      - VIDEOFOREST_PREFETCH_COUNT=${VIDEOFOREST_PREFETCH_COUNT:-3}
      - VIDEOFOREST_MAX_CONCURRENT_PREFETCH=${VIDEOFOREST_MAX_CONCURRENT_PREFETCH:-2}
    volumes:
      # SQLite 데이터베이스 영속화
      - videoforest-data:/app/data
      # HLS 임시 파일 (선택적 - 재시작 시 캐시 유지)
      - videoforest-temp:/app/backend/temp
      # 미디어 라이브러리 마운트 (읽기 전용)
      # .env 파일에서 MEDIA_PATH_1, MEDIA_PATH_2 등을 설정하세요
      # 예: MEDIA_PATH_1=/home/user/videos
      - ${MEDIA_PATH_1:?MEDIA_PATH_1 환경변수를 설정해주세요}:/media/library1:ro
      # - ${MEDIA_PATH_2}:/media/library2:ro
      # - ${MEDIA_PATH_3}:/media/library3:ro
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4001/api/auth/status').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# -----------------------------------------------------------------------------
# Named Volumes
# -----------------------------------------------------------------------------
volumes:
  videoforest-data:
    name: videoforest-data
  videoforest-temp:
    name: videoforest-temp

